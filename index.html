<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Build the Target — Ver 4</title>
<style>
  :root{
    --bg:#f5f8ff; --card:#ffffff; --ink:#0f172a; --muted:#475569;
    --accent:#2563eb; --accent-2:#0ea5e9; --ok:#16a34a; --warn:#eab308; --err:#dc2626;
    --ring:0 0 0 3px rgba(37,99,235,.25); --shadow:0 10px 20px rgba(2,6,23,.08), 0 2px 6px rgba(2,6,23,.06);
    --radius:16px;
  }
  html,body{height:100%}
  body{
    margin:0; font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    color:var(--ink); background:linear-gradient(180deg,#eef4ff,var(--bg));
  }
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px; display:grid; gap:16px}

  /* Top: calculator display + saved combos in same area */
  .topbar{
    display:grid; grid-template-columns: 2fr 1fr; gap:16px;
  }
  .display{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px 16px;
    display:grid; gap:10px;
  }
  .calc{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    background:#0b1220; color:#d9f3ff; border-radius:12px; padding:14px 16px;
    display:flex; justify-content:space-between; align-items:center; min-height:56px;
  }
  .expr{font-size:1.25rem; font-weight:700; word-break:break-word}
  .sumBadge{font-weight:800}
  .sumBadge.ok{color:#9ef0a0} .sumBadge.warn{color:#ffe08a} .sumBadge.err{color:#ff9b9b}

  .controls{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center
  }
  .control{
    display:flex; gap:8px; align-items:center; background:#f8fafc; border:1px solid #e5e7eb;
    padding:8px 10px; border-radius:12px
  }
  label{font-weight:700}
  input[type="number"]{width:88px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:10px; font-weight:700}
  input[type="number"]:focus, button:focus, .switch input:focus + .slider{outline:none; box-shadow:var(--ring)}
  .btn{
    border:0; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
    background:var(--accent); color:#fff; box-shadow:var(--shadow); transition:transform .04s
  }
  .btn.secondary{background:#0f172a0d; color:var(--ink); border:1px solid #e5e7eb}
  .btn.ghost{background:transparent; border:1px dashed #cbd5e1; color:var(--muted)}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn:active{transform:translateY(1px)}

  /* Saved area (in topbar, right column) */
  .savedWrap{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px 12px}
  .savedHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
  .list{display:grid; gap:8px; max-height:280px; overflow:auto; padding-right:4px}
  .combo{display:flex; justify-content:space-between; align-items:center; gap:8px; background:#fff; border:1px solid #e5e7eb; padding:8px 10px; border-radius:10px}
  .small{font-size:.92rem; color:var(--muted)}

  /* Middle: target frame separate from tiles/workspace */
  .mid{
    display:grid; grid-template-columns: 1fr 2fr; gap:16px;
  }

  .targetFrame{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
    display:grid; gap:12px;
  }
  .targetBox{
    border:2px solid #cbd5e1; border-radius:12px; padding:12px; background:#f8fafc; font-weight:900; font-size:1.2rem
  }

  .panel{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px
  }
  .workspace{display:grid; grid-template-columns:1fr; gap:12px}
  .workline{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    background:#f8fafc; border:1px solid #e5e7eb; padding:10px; border-radius:12px
  }
  .chips{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
  .chip{background:#eef2ff; color:#111; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px; font-weight:800}

  /* Tiles: 4 rows of 5 (1–20) with larger numbers */
  .grid{display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px}
  .tile{
    user-select:none; text-align:center; padding:18px 0; border-radius:12px; border:1px solid #e5e7eb;
    background:linear-gradient(180deg,#fff,#f6f9ff); font-weight:900; cursor:pointer; box-shadow:0 2px 4px rgba(2,6,23,.05);
    font-size:1.75rem;
  }
  .tile[aria-disabled="true"]{opacity:.45; pointer-events:none}
  .tile:hover{transform:translateY(-1px)}

  .sum{font-weight:900}
  .sum.ok{color:var(--ok)} .sum.warn{color:var(--warn)} .sum.err{color:var(--err)}

  .switch{position:relative; display:inline-block; width:46px; height:26px}
  .switch input{opacity:0; width:0; height:0}
  .slider{position:absolute; cursor:pointer; inset:0; background:#cbd5e1; border-radius:999px; transition:.2s}
  .slider:before{position:absolute; content:""; height:20px; width:20px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s; box-shadow:0 1px 2px rgba(2,6,23,.15)}
  .switch input:checked + .slider{background:linear-gradient(90deg, var(--accent), var(--accent-2))}
  .switch input:checked + .slider:before{transform:translateX(20px)}

  footer{color:var(--muted); font-size:.9rem; text-align:center; padding:8px 0}
</style>
</head>
<body>
<div class="wrap">

  <!-- TOP AREA: Calculator display + Saved (same area) -->
  <section class="topbar">
    <div class="display">
      <div class="calc">
        <div id="expr" class="expr">_ + _ = _</div>
        <div id="exprStatus" class="sumBadge warn">building…</div>
      </div>
      <div class="controls">
        <div class="control">
          <label for="target">Target</label>
          <input id="target" type="number" min="10" max="200" step="1" value="50" />
          <button class="btn" id="newTargetBtn" title="Set new target">Set</button>
        </div>
        <div class="control">
          <label for="allowRepeats">Allow Repeats</label>
          <label class="switch" title="Allow using the same tile more than once in a combination">
            <input id="allowRepeats" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
        <button class="btn secondary" id="exportBtn">Export CSV</button>
        <button class="btn secondary" id="exportPngBtn">Export PNG</button>
      </div>
    </div>

    <div class="savedWrap">
      <div class="savedHeader">
        <h3 style="margin:0">Saved</h3>
        <div class="small"><span id="countCombos">0</span> combos</div>
      </div>
      <div id="savedList" class="list" aria-live="polite"></div>
    </div>
  </section>

  <!-- MIDDLE: Target frame separate from tiles/workspace -->
  <section class="mid">
    <div class="targetFrame">
      <h3 style="margin:0">Target</h3>
      <div id="targetBox" class="targetBox">Current target: <strong>50</strong></div>
      <p class="small">Goal: Make the target using <strong>two or more</strong> numbers.</p>
    </div>

    <div class="panel workspace">
      <div class="workline" aria-live="polite">
        <div class="chips" id="currentChips"></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <div id="sumLabel" class="sum">Sum: 0</div>
          <button class="btn secondary" id="undoBtn">Undo</button>
          <button class="btn ghost" id="clearBtn">Clear</button>
          <button class="btn" id="saveBtn" disabled>Save</button>
        </div>
      </div>

      <div>
        <h3 style="margin-top:0">Tiles (1–20)</h3>
        <div id="tiles" class="grid" role="grid" aria-label="Number tiles"></div>
      </div>
    </div>
  </section>

  <footer>© Build the Target • Works offline • Data saved in your browser</footer>
</div>

<script>
(function(){
  // ---------- State ----------
  const MIN_NUMBERS = 2; // ✅ now "two or more"
  const state = {
    target: 50,
    current: [],
    allowRepeats: false,
    // savedByTarget: { [target:number]: Set<"a,b,c"> }
    savedByTarget: {}
  };

  // ---------- Elements ----------
  const tilesEl = document.getElementById('tiles');
  const currentChipsEl = document.getElementById('currentChips');
  const sumLabelEl = document.getElementById('sumLabel');
  const savedListEl = document.getElementById('savedList');
  const countCombosEl = document.getElementById('countCombos');
  const targetInput = document.getElementById('target');
  const newTargetBtn = document.getElementById('newTargetBtn');
  const saveBtn = document.getElementById('saveBtn');
  const undoBtn = document.getElementById('undoBtn');
  const clearBtn = document.getElementById('clearBtn');
  const allowRepeatsChk = document.getElementById('allowRepeats');
  const exportBtn = document.getElementById('exportBtn');
  const exportPngBtn = document.getElementById('exportPngBtn');
  const targetBox = document.getElementById('targetBox');
  const exprEl = document.getElementById('expr');
  const exprStatusEl = document.getElementById('exprStatus');

  // ---------- Persistence ----------
  const LS_KEY = 'build-target-v4';
  function load() {
    try {
      const raw = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      if (Number.isFinite(raw.target)) state.target = raw.target;
      if (raw.allowRepeats !== undefined) state.allowRepeats = !!raw.allowRepeats;
      if (raw.savedByTarget && typeof raw.savedByTarget === 'object') {
        state.savedByTarget = {};
        for (const [t, arr] of Object.entries(raw.savedByTarget)) {
          state.savedByTarget[t] = new Set(Array.isArray(arr) ? arr : []);
        }
      }
    } catch {}
  }
  function saveLS() {
    const out = { target: state.target, allowRepeats: state.allowRepeats, savedByTarget: {} };
    for (const [t, set] of Object.entries(state.savedByTarget)) {
      out.savedByTarget[t] = Array.from(set);
    }
    localStorage.setItem(LS_KEY, JSON.stringify(out));
  }

  // ---------- Utils ----------
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const keyOf = arr => [...arr].sort((a,b)=>a-b).join(',');
  const usedCountMap = arr => arr.reduce((m,v)=>(m[v]=(m[v]||0)+1,m),{});
  const getTargetSet = t => (state.savedByTarget[t] ||= new Set());
  const formatExpr = () => {
    if (state.current.length === 0) return `_ + _ = ${state.target}`;
    return `${state.current.join(' + ')} = ${sum(state.current)}`;
  };

  // ---------- Render ----------
  function renderTiles(){
    tilesEl.innerHTML = '';
    // 1..20
    for (let n=1;n<=20;n++){
      const btn = document.createElement('button');
      btn.className = 'tile';
      btn.setAttribute('role','gridcell');
      btn.setAttribute('aria-label', `Tile ${n}`);
      btn.textContent = n;
      btn.addEventListener('click', ()=>onTileClick(n));
      tilesEl.appendChild(btn);
    }
    updateTileInteractivity();
  }

  function updateTileInteractivity(){
    const map = usedCountMap(state.current);
    const allow = state.allowRepeats;
    [...tilesEl.children].forEach((b)=>{
      const val = parseInt(b.textContent,10);
      const disable = !allow && map[val] >= 1;
      b.setAttribute('aria-disabled', disable ? 'true' : 'false');
      b.tabIndex = disable ? -1 : 0;
    });
  }

  function renderCurrent(){
    // chips
    currentChipsEl.innerHTML = '';
    state.current.forEach(v=>{
      const chip = document.createElement('span');
      chip.className='chip';
      chip.textContent = v;
      currentChipsEl.appendChild(chip);
    });

    // sum + status
    const s = sum(state.current);
    let status = 'warn';
    if (s === state.target && state.current.length >= MIN_NUMBERS) status = 'ok';
    else if (s > state.target) status = 'err';
    sumLabelEl.className = `sum ${status}`;
    const need = state.current.length < MIN_NUMBERS ? ` • need ≥${MIN_NUMBERS} numbers` : '';
    sumLabelEl.textContent = `Sum: ${s} / Target: ${state.target}${need}`;

    // calculator display
    exprEl.textContent = formatExpr();
    exprStatusEl.className = `sumBadge ${status}`;
    exprStatusEl.textContent = (status==='ok'?'ready':'building…');

    // save button
    const k = keyOf(state.current);
    const canSave = (s === state.target) && (state.current.length >= MIN_NUMBERS) && !getTargetSet(state.target).has(k);
    saveBtn.disabled = !canSave;

    updateTileInteractivity();
  }

  function renderSaved(){
    const set = getTargetSet(state.target);
    const combos = Array.from(set).map(k => k.split(',').map(Number));
    combos.sort((a,b)=> a.length===b.length ? a.join(',').localeCompare(b.join(',')) : a.length-b.length);

    savedListEl.innerHTML = '';
    countCombosEl.textContent = String(combos.length);

    combos.forEach(arr=>{
      const row = document.createElement('div');
      row.className='combo';
      const left = document.createElement('div');
      left.textContent = `${arr.join(' + ')} = ${state.target}`;
      const right = document.createElement('div');
      right.className='small';
      right.textContent = `${arr.length} nums`;
      row.append(left,right);
      savedListEl.appendChild(row);
    });

    targetBox.innerHTML = `Current target: <strong>${state.target}</strong>`;
  }

  function rerenderAll(){
    targetInput.value = state.target;
    allowRepeatsChk.checked = state.allowRepeats;
    renderTiles(); renderCurrent(); renderSaved();
  }

  // ---------- Handlers ----------
  function onTileClick(n){
    if (!state.allowRepeats && state.current.includes(n)) return;
    state.current.push(n);
    renderCurrent();
  }

  undoBtn.addEventListener('click', ()=>{
    state.current.pop(); renderCurrent();
  });

  clearBtn.addEventListener('click', ()=>{
    state.current = []; renderCurrent();
  });

  saveBtn.addEventListener('click', ()=>{
    const s = sum(state.current);
    if (s !== state.target || state.current.length < MIN_NUMBERS) return;
    const key = keyOf(state.current);
    const set = getTargetSet(state.target);
    set.add(key);
    state.current = [];
    saveLS();
    renderCurrent();
    renderSaved();
  });

  newTargetBtn.addEventListener('click', ()=>{
    const t = Number(targetInput.value);
    if (Number.isFinite(t) && t>=10 && t<=200){
      state.target = Math.floor(t);
      state.current = [];
      saveLS();
      renderCurrent();
      renderSaved();
    } else {
      alert('Please set a target between 10 and 200.');
    }
  });

  allowRepeatsChk.addEventListener('change', ()=>{
    state.allowRepeats = allowRepeatsChk.checked;
    state.current = []; saveLS(); rerenderAll();
  });

  // Export CSV
  exportBtn.addEventListener('click', ()=>{
    const set = getTargetSet(state.target);
    const rows = [['target','combo','count']];
    Array.from(set).forEach(k=>{
      const arr = k.split(',').map(Number);
      rows.push([state.target, arr.join('+'), arr.length]);
    });
    const csv = rows.map(r=>r.map(String).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `build-the-target_${state.target}.csv`;
    document.body.appendChild(a);
    a.click(); URL.revokeObjectURL(url); a.remove();
  });

  // Export PNG(s) of saved list
  exportPngBtn.addEventListener('click', exportPNG);
  function exportPNG(){
    const set = getTargetSet(state.target);
    const combos = Array.from(set).map(k => k.split(',').map(Number));
    if (combos.length === 0){ alert('No saved combinations for this target yet.'); return; }

    const title = `Build the Target — Target ${state.target}`;
    const subtitle = `${combos.length} unique combinations (order doesn’t matter)`;
    const padding = 24, colGap = 40, lineH = 28, headerH = 72, colWidth = 420, maxCanvasHeight = 1200;
    const rowsPerCol = Math.max(1, Math.floor((maxCanvasHeight - padding*2 - headerH) / lineH));
    const rows = combos
      .sort((a,b)=> a.length===b.length ? a.join(',').localeCompare(b.join(',')) : a.length-b.length)
      .map(arr => `${arr.join(' + ')} = ${state.target}`);

    const totalRows = rows.length;
    const totalCols = Math.ceil(totalRows / rowsPerCol);
    const maxColsPerImage = 3;
    const totalImages = Math.ceil(totalCols / maxColsPerImage);
    const dpr = Math.min(window.devicePixelRatio || 1, 2);

    function drawImage(imageIndex){
      const startCol = imageIndex * maxColsPerImage;
      const endCol = Math.min(startCol + maxColsPerImage, totalCols);
      const colsInThis = endCol - startCol;

      const rowsInLastCol = (imageIndex === totalImages-1 && endCol === totalCols)
        ? totalRows - (startCol * rowsPerCol) - ((colsInThis-1) * rowsPerCol)
        : rowsPerCol;
      const contentHeight = headerH + Math.max(rowsPerCol, rowsInLastCol) * lineH;

      const canvasWidth = padding*2 + colsInThis*colWidth + (colsInThis-1)*colGap;
      const canvasHeight = padding*2 + contentHeight;

      const canvas = document.createElement('canvas');
      canvas.width = Math.ceil(canvasWidth * dpr);
      canvas.height = Math.ceil(canvasHeight * dpr);
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);

      ctx.fillStyle = '#f5f8ff';
      ctx.fillRect(0,0,canvasWidth,canvasHeight);

      ctx.fillStyle = '#0f172a';
      ctx.font = '700 22px system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial';
      ctx.fillText(title, padding, padding + 26);

      ctx.fillStyle = '#475569';
      ctx.font = '400 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial';
      ctx.fillText(subtitle, padding, padding + 26 + 22);

      ctx.fillStyle = '#0f172a';
      ctx.font = '600 18px system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial';

      for (let col=0; col<colsInThis; col++){
        const globalCol = startCol + col;
        const x0 = padding + col*(colWidth + colGap);
        const startRowIdx = globalCol * rowsPerCol;
        const endRowIdx = Math.min(startRowIdx + rowsPerCol, rows.length);

        for (let r=startRowIdx; r<endRowIdx; r++){
          const line = rows[r];
          const y = padding + headerH + (r - startRowIdx + 1) * lineH - (lineH/6);
          ctx.fillText(line, x0, y);
        }
      }

      const pageSuffix = (totalImages > 1) ? `_p${imageIndex+1}` : '';
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `build-the-target_${state.target}${pageSuffix}.png`;
      document.body.appendChild(a);
      a.click(); a.remove();
    }

    for (let i=0;i<totalImages;i++) drawImage(i);
  }

  // Keyboard shortcuts: digits 1-9, 0->10; Backspace undo; Esc clear
  document.addEventListener('keydown', (e)=>{
    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
    const k = e.key;
    if (k === 'Backspace'){ e.preventDefault(); undoBtn.click(); }
    else if (k === 'Escape'){ clearBtn.click(); }
    else if (/^[0-9]$/.test(k)){
      let v = Number(k);
      if (v === 0) v = 10;
      if (v >= 1 && v <= 10) onTileClick(v);
    }
  });

  // ---------- Init ----------
  load(); rerenderAll();
})();
</script>
</body>
</html>
