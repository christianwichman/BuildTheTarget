<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Build the Target — Ver 7.1 (Tiles Fix)</title>
<style>
  :root{
    --bg:#f5f8ff; --card:#ffffff; --ink:#0f172a; --muted:#475569;
    --accent:#2563eb; --accent-2:#0ea5e9; --ok:#16a34a; --warn:#eab308; --err:#dc2626;
    --ring:0 0 0 3px rgba(37,99,235,.25); --shadow:0 10px 20px rgba(2,6,23,.08), 0 2px 6px rgba(2,6,23,.06);
    --radius:16px;
  }
  html,body{height:100%}
  body{
    margin:0; font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    color:var(--ink); background:linear-gradient(180deg,#eef4ff,var(--bg));
  }
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px; display:grid; gap:16px}
  .topbar{display:grid; grid-template-columns: 2fr 1fr; gap:16px}
  .display{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px 16px; display:grid; gap:10px}
  .calc{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    background:#0b1220; color:#d9f3ff; border-radius:12px; padding:14px 16px;
    display:flex; justify-content:space-between; align-items:center; min-height:56px;
  }
  .expr{font-size:1.25rem; font-weight:700; word-break:break-word}
  .sumBadge{font-weight:800}
  .sumBadge.ok{color:#9ef0a0} .sumBadge.warn{color:#ffe08a} .sumBadge.err{color:#ff9b9b}

  .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .control{display:flex; gap:8px; align-items:center; background:#f8fafc; border:1px solid #e5e7eb; padding:8px 10px; border-radius:12px}
  label{font-weight:700}
  input[type="number"]{width:88px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:10px; font-weight:700}
  input[type="number"]:focus, button:focus{outline:none; box-shadow:var(--ring)}
  .btn{border:0; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; background:var(--accent); color:#fff; box-shadow:var(--shadow); transition:transform .04s}
  .btn.secondary{background:#0f172a0d; color:var(--ink); border:1px solid #e5e7eb}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn:active{transform:translateY(1px)}

  .savedWrap{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px 12px}
  .savedHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
  .list{display:grid; gap:8px; max-height:280px; overflow:auto; padding-right:4px}
  .combo{display:flex; justify-content:space-between; align-items:center; gap:8px; background:#fff; border:1px solid #e5e7eb; padding:8px 10px; border-radius:10px}
  .small{font-size:.92rem; color:var(--muted)}

  .mid{display:grid; grid-template-columns: 1fr 2fr; gap:16px}
  .targetFrame{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:grid; gap:12px}
  .targetBox{border:2px solid #cbd5e1; border-radius:12px; padding:12px; background:#f8fafc; font-weight:900; font-size:1.2rem}

  .panel{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .workspace{display:grid; grid-template-columns:1fr; gap:12px}
  .workline{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; background:#f8fafc; border:1px solid #e5e7eb; padding:10px; border-radius:12px}
  .chips{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
  .chip{background:#eef2ff; color:#111; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px; font-weight:800}

  .grid{display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px}
  .tile{
    user-select:none; text-align:center; padding:18px 0; border-radius:12px; border:1px solid #e5e7eb;
    background:linear-gradient(180deg,#fff,#f6f9ff); font-weight:900; cursor:pointer; box-shadow:0 2px 4px rgba(2,6,23,.05);
    font-size:1.75rem;
  }
  .tile:hover{transform:translateY(-1px)}

  .sum{font-weight:900}
  .sum.ok{color:var(--ok)} .sum.warn{color:var(--warn)} .sum.err{color:var(--err)}

  footer{color:var(--muted); font-size:.9rem; text-align:center; padding:8px 0}
</style>
</head>
<body>
<div class="wrap">

  <section class="topbar">
    <div class="display">
      <div class="calc">
        <div id="expr" class="expr">_ + _ = _</div>
        <div id="exprStatus" class="sumBadge warn">building…</div>
      </div>
      <div class="controls">
        <div class="control">
          <label for="target">Target</label>
          <!-- min set to 2 to match the solvable range -->
          <input id="target" type="number" min="2" max="25" step="1" value="10" />
          <button class="btn" id="newTargetBtn" title="Set target">Set</button>
        </div>
        <button class="btn secondary" id="randomBtn" title="Pick a random target (2–25)">Random Target</button>
        <button class="btn secondary" id="newRoundBtn" title="Clear & randomize target">New Round</button>
        <button class="btn secondary" id="exportPngBtn" title="Download saved combinations as PNG">Export PNG</button>
      </div>
    </div>

    <div class="savedWrap">
      <div class="savedHeader">
        <h3 style="margin:0">Saved</h3>
        <div class="small"><span id="countCombos">0</span> combos</div>
      </div>
      <div id="savedList" class="list" aria-live="polite"></div>
    </div>
  </section>

  <section class="mid">
    <div class="targetFrame">
      <h3 style="margin:0">Target</h3>
      <div id="targetBox" class="targetBox">Current target: <strong>10</strong></div>
      <p class="small">Goal: Make the target using <strong>two or more</strong> numbers. (Repeats allowed.)</p>
    </div>

    <div class="panel workspace">
      <div class="workline" aria-live="polite">
        <div class="chips" id="currentChips"></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <div id="sumLabel" class="sum">Sum: 0</div>
          <button class="btn secondary" id="undoBtn">Undo</button>
          <button class="btn secondary" id="clearBtn">Clear</button>
          <button class="btn" id="saveBtn" disabled>Save</button>
        </div>
      </div>

      <div>
        <h3 style="margin-top:0">Tiles (1–20)</h3>
        <div id="tiles" class="grid" role="grid" aria-label="Number tiles"></div>
      </div>
    </div>
  </section>

  <footer>© Build the Target • Works offline • Data saved in your browser</footer>
</div>

<script>
(function(){
  // ---------- Settings ----------
  const MIN_NUMBERS = 2;                 // combos must use two or more numbers
  const REPEATS_ALLOWED = true;          // repeats permanently on
  const RANDOM_MIN = 2, RANDOM_MAX = 25; // classroom bounds for solvable targets

  // ---------- State ----------
  const state = {
    target: 10,
    current: [],
    // savedByTarget: { [target:number]: Set<"a,b,c"> }
    savedByTarget: {}
  };

  // ---------- Elements ----------
  const tilesEl = document.getElementById('tiles');
  const currentChipsEl = document.getElementById('currentChips');
  const sumLabelEl = document.getElementById('sumLabel');
  const savedListEl = document.getElementById('savedList');
  const countCombosEl = document.getElementById('countCombos');
  const targetInput = document.getElementById('target');
  const newTargetBtn = document.getElementById('newTargetBtn');
  const randomBtn = document.getElementById('randomBtn');
  const newRoundBtn = document.getElementById('newRoundBtn');
  const saveBtn = document.getElementById('saveBtn');
  const undoBtn = document.getElementById('undoBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportPngBtn = document.getElementById('exportPngBtn');
  const targetBox = document.getElementById('targetBox');
  const exprEl = document.getElementById('expr');
  const exprStatusEl = document.getElementById('exprStatus');

  // ---------- Persistence ----------
  const LS_KEY = 'build-target-v7.1';
  function load() {
    try {
      const raw = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      if (Number.isFinite(raw.target)) state.target = raw.target;
      if (raw.savedByTarget && typeof raw.savedByTarget === 'object') {
        state.savedByTarget = {};
        for (const [t, arr] of Object.entries(raw.savedByTarget)) {
          state.savedByTarget[t] = new Set(Array.isArray(arr) ? arr : []);
        }
      }
    } catch {}
  }
  function saveLS() {
    const out = { target: state.target, savedByTarget: {} };
    for (const [t, set] of Object.entries(state.savedByTarget)) {
      out.savedByTarget[t] = Array.from(set);
    }
    localStorage.setItem(LS_KEY, JSON.stringify(out));
  }

  // ---------- Utils ----------
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const keyOf = arr => [...arr].sort((a,b)=>a-b).join(',');
  const getTargetSet = t => (state.savedByTarget[t] ||= new Set());
  const formatExpr = () => state.current.length ? `${state.current.join(' + ')} = ${sum(state.current)}` : `_ + _ = ${state.target}`;
  const randInt = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

  // ---------- Render ----------
  function renderTiles(){
    tilesEl.innerHTML = '';
    for (let n=1;n<=20;n++){
      const btn = document.createElement('button');
      btn.className = 'tile';
      btn.setAttribute('role','gridcell');
      btn.setAttribute('aria-label', `Tile ${n}`);
      btn.textContent = n;
      btn.addEventListener('click', ()=>onTileClick(n));
      tilesEl.appendChild(btn);
    }
  }

  function renderCurrent(){
    currentChipsEl.innerHTML = '';
    state.current.forEach(v=>{
      const chip = document.createElement('span');
      chip.className='chip';
      chip.textContent = v;
      currentChipsEl.appendChild(chip);
    });

    const s = sum(state.current);
    let status = 'warn';
    if (s === state.target && state.current.length >= MIN_NUMBERS) status = 'ok';
    else if (s > state.target) status = 'err';
    sumLabelEl.className = `sum ${status}`;
    const need = state.current.length < MIN_NUMBERS ? ` • need ≥${MIN_NUMBERS} numbers` : '';
    sumLabelEl.textContent = `Sum: ${s} / Target: ${state.target}${need}`;

    exprEl.textContent = formatExpr();
    exprStatusEl.className = `sumBadge ${status}`;
    exprStatusEl.textContent = (status==='ok'?'ready':'building…');

    const k = keyOf(state.current);
    const canSave = (s === state.target) && (state.current.length >= MIN_NUMBERS) && !getTargetSet(state.target).has(k);
    saveBtn.disabled = !canSave;
  }

  function renderSaved(){
    const set = getTargetSet(state.target);
    const combos = Array.from(set).map(k => k.split(',').map(Number));
    combos.sort((a,b)=> a.length===b.length ? a.join(',').localeCompare(b.join(',')) : a.length-b.length);

    savedListEl.innerHTML = '';
    countCombosEl.textContent = String(combos.length);

    combos.forEach(arr=>{
      const row = document.createElement('div');
      row.className='combo';
      const left = document.createElement('div');
      left.textContent = `${arr.join(' + ')} = ${state.target}`;
      const right = document.createElement('div');
      right.className='small';
      right.textContent = `${arr.length} nums`;
      row.append(left,right);
      savedListEl.appendChild(row);
    });

    targetBox.innerHTML = `Current target: <strong>${state.target}</strong>`;
  }

  function rerenderAll(){
    document.getElementById('target').value = state.target;
    renderTiles(); renderCurrent(); renderSaved();
  }

  // ---------- Handlers ----------
  function onTileClick(n){
    state.current.push(n); // repeats allowed
    renderCurrent();
  }

  undoBtn.addEventListener('click', ()=>{ state.current.pop(); renderCurrent(); });
  clearBtn.addEventListener('click', ()=>{ state.current = []; renderCurrent(); });

  saveBtn.addEventListener('click', ()=>{
    const s = sum(state.current);
    if (s !== state.target || state.current.length < MIN_NUMBERS) return;
    const key = keyOf(state.current);
    const set = getTargetSet(state.target);
    set.add(key);
    state.current = [];
    saveLS();
    renderCurrent();
    renderSaved();
  });

  // Clamp to 2–25 for solvability with ≥2 numbers
  function clampTarget(t){
    if (t < 2){
      alert('With at least two numbers, the smallest possible sum is 2 (1+1). Target set to 2.');
      return 2;
    }
    if (t > 25) return 25;
    return Math.floor(t);
  }

  newTargetBtn.addEventListener('click', ()=>{
    let t = Number(targetInput.value);
    if (!Number.isFinite(t)){ alert('Please enter a number.'); return; }
    t = clampTarget(t);
    state.target = t;
    state.current = [];
    targetInput.value = t;
    saveLS(); renderCurrent(); renderSaved();
  });

  function randomizeTarget(){
    state.target = randInt(RANDOM_MIN, RANDOM_MAX);
    targetInput.value = state.target;
    state.current = [];
    saveLS(); renderCurrent(); renderSaved();
  }
  randomBtn.addEventListener('click', randomizeTarget);
  newRoundBtn.addEventListener('click', randomizeTarget);

  // ---- Export PNG(s) of saved combos ----
  exportPngBtn.addEventListener('click', exportPNG);
  function exportPNG(){
    const set = getTargetSet(state.target);
    const combos = Array.from(set).map(k => k.split(',').map(Number));
    if (combos.length === 0){ alert('No saved combinations for this target yet.'); return; }

    const title = `Build the Target — Target ${state.target}`;
    const subtitle = `${combos.length} unique combinations (order doesn’t matter)`;
    const padding = 24, colGap = 40, lineH = 28, headerH = 72, colWidth = 420, maxCanvasHeight = 1200;
    const rowsPerCol = Math.max(1, Math.floor((maxCanvasHeight - padding*2 - headerH) / lineH));
    const rows = combos
      .sort((a,b)=> a.length===b.length ? a.join(',').localeCompare(b.join(',')) : a.length-b.length)
      .map(arr => `${arr.join(' + ')} = ${state.target}`);

    const totalRows = rows.length;
    const totalCols = Math.ceil(totalRows / rowsPerCol);
    const maxColsPerImage = 3;
    const totalImages = Math.ceil(totalCols / maxColsPerImage);
    const dpr = Math.min(window.devicePixelRatio || 1, 2);

    function drawImage(imageIndex){
      const startCol = imageIndex * maxColsPerImage;
      const endCol = Math.min(startCol + maxColsPerImage, totalCols);
      const colsInThis = endCol - startCol;

      const rowsInLastCol = (imageIndex === totalImages-1 && endCol === totalCols)
        ? totalRows - (startCol * rowsPerCol) - ((colsInThis-1) * rowsPerCol)
        : rowsPerCol;
      const contentHeight = headerH + Math.max(rowsPerCol, rowsInLastCol) * lineH;

      const canvasWidth = padding*2 + colsInThis*colWidth + (colsInThis-1)*colGap;
      const canvasHeight = padding*2 + contentHeight;

      const canvas = document.createElement('canvas');
      canvas.width = Math.ceil(canvasWidth * dpr);
      canvas.height = Math.ceil(canvasHeight * dpr);
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);

      ctx.fillStyle = '#f5f8ff'; ctx.fillRect(0,0,canvasWidth,canvasHeight);

      ctx.fillStyle = '#0f172a';
      ctx.font = '700 22px system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial';
      ctx.fillText(title, padding, padding + 26);

      ctx.fillStyle = '#475569';
      ctx.font = '400 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial';
      ctx.fillText(subtitle, padding, padding + 26 + 22);

      ctx.fillStyle = '#0f172a';
      ctx.font = '600 18px system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial';

      for (let col=0; col<colsInThis; col++){
        const globalCol = startCol + col;
        const x0 = padding + col*(colWidth + colGap);
        const startRowIdx = globalCol * rowsPerCol;
        const endRowIdx = Math.min(startRowIdx + rowsPerCol, rows.length);

        for (let r=startRowIdx; r<endRowIdx; r++){
          const line = rows[r];
          const y = padding + headerH + (r - startRowIdx + 1) * lineH - (lineH/6);
          ctx.fillText(line, x0, y);
        }
      }

      const pageSuffix = (totalImages > 1) ? `_p${imageIndex+1}` : '';
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `build-the-target_${state.target}${pageSuffix}.png`;
      document.body.appendChild(a);
      a.click(); a.remove();
    }

    for (let i=0;i<totalImages;i++) drawImage(i);
  }

  // Keyboard shortcuts: digits 1-9, 0->10; Backspace undo; Esc clear
  document.addEventListener('keydown', (e)=>{
    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
    const k = e.key;
    if (k === 'Backspace'){ e.preventDefault(); undoBtn.click(); }
    else if (k === 'Escape'){ clearBtn.click(); }
    else if (/^[0-9]$/.test(k)){
      let v = Number(k);
      if (v === 0) v = 10;
      if (v >= 1 && v <= 10) onTileClick(v);
    }
  });

  // ---------- Init ----------
  load(); rerenderAll();
})();
</script>
</body>
</html>
